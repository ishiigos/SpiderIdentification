<html>

<head>
    <title>Spider Identification Key</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <style>
        :root {
            --light-yellow-green: #fef9db;
            --light-lime: #abd699;
            --fresh-lemon: #ffe26a;
            --teal: #75c9b7;
            --mint: #c7ddcc;
            --navy: #16123f;
            --dark-grey: #9e9e9e;
        }

        /* body {
            background-color: var(--light-yellow-green);
        } */
        .header {
            background-color: var(--light-lime);
            padding: 0.5rem;
            color: var(--navy);
        }

        select.form-select:disabled {
            background-color: var(--dark-grey);
        }

        .bg-light-lime {
            background-color: var(--light-lime);
        }

        .bg-teal {
            background-color: var(--teal);
        }

        .bg-light-yellow-green {
            background-color: var(--light-yellow-green);
        }

        .bg-mint {
            background-color: var(--mint);
        }

        .list-item {
            margin: 2px;
            border: 1px solid;
        }

        .list-item select {
            width: 100%
        }

        .list {
            overflow-y: auto;
            height: 500px;
            max-height: 500px;
            border: 2px solid;
        }

        .left,
        .right {
            width: 40%
        }

        .left {
            padding-right: 2%
        }

        .right>div:nth-child(n+2) {
            padding-top: 1rem;
        }

        .lists-wrapper {
            display: flex;
            place-content: center;
        }

        .filter {
            display: flex;
            align-items: center;
        }

        .filter:nth-child(n+2) {
            padding-top: 0.5rem;
        }

        .result-wrapper {
            display: flex;
            justify-content: center;
        }

        #spiderTable_wrapper {
            width: 82%;
        }

        .dropdown-wrapper {
            width: 14rem;
            max-width: 14rem;
        }

        .btn-add {
            visibility: hidden;
        }

        .filter:last-child .btn-add {
            visibility: visible;
        }

        .delete-confirmation-wrapper {
            display: none;
        }

        .btn-confirm-yes,
        .btn-confirm-yes:hover {
            color: red;
        }

        .remove-all {
            background-color: rgb(255, 255, 255);
            color: rgb(114, 1, 1);
            border-width: 2px;
            border-color: rgb(114, 1, 1);
            height: 40px;
            width: 100px;
            border-radius: 20px;
            cursor: pointer;
            margin-right: 8px;
            visibility: hidden;
        }

        .filter:last-child .remove-all {
            visibility: visible;
        }

        .remove-all:hover {
            opacity: 0.7;
        }

        .remove-all:active {
            opacity: 0.5;
        }

        .medium-height {
            height: 600px;
        }

        .modal-dialog{
            max-width:50%;
        }

        #spiderTableBody tr{
            cursor: pointer;
        }

        /*Chart summary*/
        #chart-summary {
            display: none;
        }

        #chart-summary-tbody td {
            padding: 0.5rem;
            padding-right: 1rem;
        }

        .summary-table-wrapper table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table-wrapper th {
            position: sticky;
            top: 0;
            background-color: var(--light-lime);
        }

        .summary-table-wrapper thead th {
            z-index: 1;
        }

        .summary-table-wrapper {
            overflow-y: scroll;
            height: 500px;
        }

        .summary-table-wrapper td,
        .summary-table-wrapper th {
            padding: 8px;
            border: 1px solid #dddddd;
            text-align: left;
        }

        .modal-header{
            background-color: var(--light-lime);
        }

        /* Chart css */
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        .node text {
            font-size: 12px;
            font-family: sans-serif;
            pointer-events: none;
            text-anchor: middle;
        }

        .node--root circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.6.4.js"
        integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E=" crossorigin="anonymous"></script>

    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>

    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        const allCharacteristics = {
                "Sex": ["Male", "Female"],
                "Overall Appearance": ["inconspicuous, generally dark", "bright, red, orange", "conspicuous contrast legs/prosoma", "pale, ground or cave dweller"],
                "Length of prosoma [mm]": ["0.44", "0.45", "0.46", "0.47", "0.48", "0.49", "0.5", "0.51", "0.52", "0.53", "0.54", "0.55", "0.56", "0.57", "0.58", "0.59", "0.6", "0.61", "0.62", "0.63", "0.64", "0.65", "0.66", "0.67", "0.68", "0.69", "0.7", "0.71", "0.72", "0.73", "0.74", "0.75", "0.76", "0.77", "0.78", "0.79", "0.8", "0.81", "0.82", "0.83", "0.84", "0.85", "0.86", "0.87", "0.88", "0.89", "0.9", "0.91", "0.92", "0.93", "0.94", "0.95", "0.96", "0.97", "0.98", "0.99", "mm", "1.01", "1.02", "1.03", "1.04", "1.05", "1.06", "1.07", "1.08", "1.09", "1.1", "1.11", "1.12", "1.13", "1.15", "1.16", "1.17", "1.18", "1.19", "1.2", "1.21", "1.22", "1.25", "1.26", "1.27", "1.28", "1.3", "1.32", "1.34", "1.35", "1.38", "1.4", "1.41", "1.42", "1.45", "1.47", "1.5", "1.55", "1.58", "1.6", "1.62", "1.65", "1.66", "1.7", "1.75", "1.8", "1.85", "1.9", "1.95", "1.98", "2", "2.05", "2.09", "2.1", "2.15", "2.2", "2.25", "2.3", "2.4", "2.5", "3.0"],
                "Length of prosoma by range [mm]": ["0.4-0.6", "0.6-0.8", "0.8-1.0", "1.0-1.2", "1.2-1.4", "1.4-1.6", "1.6-1.8", "1.8-2.0", "2.0-2.2", "2.2-2.4", "2.4-2.6", "2.6-2.8", "2.8-3.0"],
                "Length of femur I :&lt;relative to prosoma&gt;": ["equal in length", "longer than prosoma", "shorter than prosoma"],
                "Prosoma &lt;appearance&gt;": ["inconspicuous", "margins with teeth", "with conspicuous hairs/spines", "with pits (dorsally)"],
                "Fovea as darkened groove": ["yes", "no"],
                "Opisthosoma &lt;appearance&gt;": ["conspicuously hairy", "patterned", "unicolourous, inconspicuous", "with scutum"],
                "Dorsal spines on femur I: &lt;count&gt;": ["multiple", "none", "one"],
                "Posterior eye row: &lt;form&gt;": ["procurved", "recurved", "straight"],
                "Posterior median eye (PME) separation: &lt;relative to diameter (d)&gt;": ["distinctly greater than d", "distinctly less than d", "equal to d"],
                "Headregion of male: &lt;appearance&gt;": ["complex", "inconspicuous", "sulci present", "with lobe (simple)", "with horns/tufts"],
                "Eyes: &lt;appearance&gt;": ["normal", "reduced"],
                "Anterior median eyes: &lt;size relative to anterior lateral eyes ALE&gt;": ["about the same as ALE", "distinctly larger than ALE", "distinctly smaller than ALE"],
                "Anterior cheliceral teeth: &lt;appearance&gt;": ["conspicuously large", "unremarkable in size"],
                "Prolateral spines on femur I: &lt;count&gt;": ["multiple", "none", "one"],
                "Prolateral spines on tibia I: &lt;count&gt;": ["multiple", "none", "one"],                
                "Conspicuous structures on chelicerae: &lt;appearance&gt;": ["apophyses/teeth-like processes/tubercles", "none", "spines"],
                "Maxillae: &lt;appearance&gt;": ["one or more teeth/tubercles", "unremarkable"],
                "Sternum: &lt;appearance&gt;": ["pitted", "rugose", "smooth"],
                "Sternum: &lt;extends between coxae IV&gt;": ["yes", "no"],
                "Width of sternum between coxae IV: &lt;relative to width of coxae IV (d)&gt;": ["distinctly greater than d", "distinctly less than d", "equal to d"],
                "Position of trichobothrium on metatarsus I (TmI): &lt;relative to metatarsus&gt;": ["0.11", "0.12", "0.13", "0.14", "0.15", "0.16", "0.17", "0.18", "0.19", "0.2", "0.21", "0.22", "0.23", "0.24", "0.25", "0.26", "0.27", "0.28", "0.29", "0.3", "0.31", "0.32", "0.33", "0.34", "0.35", "0.36", "0.37", "0.38", "0.39", "0.4", "0.41", "0.42", "0.43", "0.44", "0.45", "0.46", "0.47", "0.48", "0.49", "0.5", "0.51", "0.52", "0.53", "0.54", "0.55", "0.56", "0.57", "0.58", "0.59", "0.6", "0.61", "0.62", "0.63", "0.64", "0.65", "0.66", "0.67", "0.68", "0.69", "0.7", "0.71", "0.72", "0.73", "0.74", "0.75", "0.76", "0.77", "0.78", "0.79", "0.8", "0.81", "0.82", "0.83", "0.84", "0.85", "0.86", "0.87", "0.88", "0.89", "0.9", "0.91", "0.92", "0.93", "0.94", "0.95", "0.96", "0.97", "0.98"],
                "Position of TmI by range: &lt;relative to metatarsus&gt;": ["0.10-0.19", "0.20-0.29", "0.30-0.39", "0.40-0.49", "0.50-0.59", "0.60-0.69", "0.70-0.79", "0.80-0.89", "0.90-0.98"],
                "Metatarsus IV dorsally: &lt;presence of trichobothrium (TmIV)&gt;": [" trichobothrium present", "trichobothrium absent"],
                "Dorsal spines on metatarsus I: &lt;count&gt;": ["multiple", "none", "one"],
                "Tibia IV: &lt;number of dorsal spines&gt;": ["one dorsal spine", "two dorsal spines"],
                "Numbers of dorsal spines on tibia I, II, III, IV: &lt;tibial spine formula&gt;": ["0", "11", "1111", "2211", "2221", "2222"],
                "Tibia I-II ventrally: &lt;presence of spines&gt;": ["no spines", "stout spines in two rows"],
                "Male pedipalp: femur &lt;appearance&gt;": ["unremarkable", "conspicuous"],
                "Male pedipalp: patella &lt;appearance&gt;": ["conspicuously swollen", "unremarkable", "with apophyses", "with conspicuous spines (single or tufts)"],
                "Male pedipalp: tibia &lt;appearance&gt;": ["unremarkable", "with complex apophysis", "with multiple, complex apophysis", "with multiple, simple apophysis", "with one or more spines", "with simple apophysis", "with tufts of hair or spines"],
                "Male pedipalp: cymbium &lt;appearance&gt;": ["margin with notches/bulges", "bulges", "with dorsal projections/conical elevations"],
                "Male pedipalp: paracymbium &lt;form&gt;": ["complex", "simple"],
                "Male pedipalp: branches of paracymbium &lt;presence of teeth&gt;": ["teeth absent", "teeth present"],
                "Male pedipalp: embolus &lt;appearance&gt;": ["conspicuous, circular", "conspicuous, curled", "unremarkable"],
                "Male pedipalp: lamella characteristica &lt;presence&gt;": ["absent", "conspicuous"],
                "Female palp: claw &lt;presence&gt;": ["conspicuous", "not present/ inconspicuous"],
                "Epigyne: &lt;form&gt;": ["flat", "protrudes"],
                "Epigyne: &lt;seminal receptacles&gt;": ["underlying structures (e.g., seminal receptacles) not visible", "underlying structures (e.g., seminal receptacles) visible"],
                "Distribution": ["Albania", "Andorra", "Armenia", "Austria", "Azerbaijan", "Belarus", "Belgium", "Bosnia and Herzegovina", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Faroe Islands", "Finland", "France", "France / Corsica", "Georgia", "Germany", "Gibraltar (UK)", "Greece", "Greece / Crete", "Hungary", "Iceland", "Ireland", "Italy", "Italy / Sardinia", "Italy / Sicily", "Kosovo", "Latvia", "Liechtenstein", "Lithuania", "Luxembourg", "Macedonia", "Malta", "Moldova", "Montenegro", "Netherlands", "Northern Island", "Norway", "Poland", "Portugal", "Romania", "Russia, Central", "Russia, Eastern", "Russia, Franz Jozef Land", "Russia, Kaliningrad Region", "Russia, Northern", "Russia, Novaya Zemlya", "Russia, Southern", "Russia, Western", "Serbia", "Slovakia", "Slovenia", "Spain", "Spain / Balearic Islands", "Svalbard", "Sweden", "Switzerland", "Turkey (Asia)", "Turkey (Europe)", "Ukraine", "United Kingdom"]
        }

        const selectCharacteristicsText = '--Select Characteristic--';
        const diameter = 600;
        var selectedCharacteristicKeys = [];

        var priorCharacteristicKeys = [];

        //Stored priors has index 0 as the default values
        var storedPriors = [];

        var spidersTable;

        var svg;
        var pack;

        class Prior {
            constructor(characteristicKey, prior) {
                this.characteristicKey = characteristicKey;
                this.prior = prior;
            }
        }

        function initialiseBubbleChart() {
            let format;
            let width;
            let height;
            svg = d3.select("svg"),
                width = +svg.attr("width"),
                height = +svg.attr("height"),
                format = d3.format(",d"),
                pack = d3.pack()
                    .size([width, height])
                    .padding(1.5);
        }

        function initialiseToastr() {
            //Can change the options below to customise the behaviour of toastr
            toastr.options = {
                "positionClass": "toast-bottom-right"
            }
        }

        function generateBubbleChartAndDisplaySummary(priors) {
            let data = [];

            // Create data array and sort in descending order of value
            $.each(priors, function (index, value) {
                let temp = {
                    name: value['Species Name'],
                    value: value['Posterior']
                };
                data.push(temp);
            });

            data.sort(function (a, b) { return b.value - a.value; });

            let root = d3.hierarchy({ children: data })
                .sum(function (d) { return d.value; });

            let packLayout = d3.pack()
                .size([diameter, diameter])
                .padding(5);

            packLayout(root);

            var node = svg.selectAll(".node")
                .data(root.descendants());

            node.exit().remove();

            var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });

            nodeEnter.append("circle")
                .attr("r", function (d) { return d.r; });

            nodeEnter.append("title")
                .text(function (d) { return d.data.name + "\n" + d.value; });

            var nodeUpdate = nodeEnter.merge(node);

            nodeUpdate.select("circle")
                .attr("r", function (d) { return d.r; });

            // Update the labels in the bubbles
            nodeUpdate.select("text")
                .text(function (d) { return d.data.name.substring(0, d.r / 3); });

            // Update the titles in the bubbles
            nodeUpdate.select("title")
                .text(function (d) { return d.data.name + "\n" + d.value; });

            displayBubbleChartSummary(priors);
        }

        function displayBubbleChartSummary(priors) {
            let posteriorWithCounts = priors.reduce((dict, obj) => {
                let posteriorValue = obj.Posterior;
                let count = dict[posteriorValue] || 0;
                dict[posteriorValue] = count + 1;
                return dict;
            }, {});

            let htmlArray = [];
            for (let posteriorCount in posteriorWithCounts) {
                htmlArray.push(`<tr>
                                    <td>${posteriorCount}</td>
                                    <td>${posteriorWithCounts[posteriorCount]}</td>
                                </tr>`);
            }
            document.getElementById('chart-summary-tbody').innerHTML = htmlArray.join('');
            if (htmlArray.length > 0)
                document.getElementById('chart-summary').style.display = 'block';
            else
                document.getElementById('chart-summary').style.display = 'none';
        }

        $(document).ready(function () {
            addFilter();
            getSpidersForSelection('', '');
            initialiseBubbleChart();
            initialiseToastr();
        });

        function generateDropDownOptionsHtml(options, defaultText, onChangeFunctionName) {
            let filterOptions = [];
            filterOptions.push(`<select onchange="${onChangeFunctionName}(event)" class="form-select">`);
            filterOptions.push(`<option>${defaultText}</option>`);
            options.forEach(option => {
                filterOptions.push(`<option value="${option}">${option}</option>`);
            });
            filterOptions.push('</select>');
            return filterOptions.join('');
        }

        function convertToHtmlCompatibleValue(value) {
            return value.replace("<", "&lt;").replace(">", "&gt;");
        }

        function convertFromHtmlCompatibleValue(value) {
            return value.replace("&lt;", "<").replace("&gt;", ">");
        }

        function getCharacteristicsPossibleValues(characteristic) {
            let characteristicKey = convertToHtmlCompatibleValue(characteristic);
            return allCharacteristics[characteristicKey];
        }

        function onCharacteristicKeySelected(event) {
            event.srcElement.children[0].disabled = true;
            let selectedValue = event.target.value;
            let characteristicValues = getCharacteristicsPossibleValues(selectedValue);
            let characteristicValuesOptions = generateDropDownOptionsHtml(characteristicValues, "--Select Value--", "selectCharacteristicValue");
            event.srcElement.parentElement.parentElement.children[2].innerHTML = characteristicValuesOptions;
        }

        function validateAndAddFilter(event) {
            if (isAddingFilterAllowed(event)) {
                addFilter();
            }
            else {
                toastr.warning('Please select characteristic and its value to this filter before adding a new one.');
            }
        }

        function isAddingFilterAllowed(event) {
            let rowCharacteristicValue = event.srcElement.parentElement.parentElement.parentElement.getElementsByClassName('characteristic-value')[0].children[0].value;
            if (rowCharacteristicValue == '' || rowCharacteristicValue == '--Select Value--')
                return false;
            else
                return true;
        }

        function addFilter() {
            let filtersElement = document.getElementById('filters');
            let newFilter = document.createElement('div');
            newFilter.className = 'filter';
            newFilter.innerHTML = createFilterInnerHtml();
            filtersElement.appendChild(newFilter);
        }

        function getCharacteristicKeysForOptions() {
            let tempKeys = Object.keys(allCharacteristics);
            if (selectedCharacteristicKeys.length > 0) {
                return tempKeys.filter((x) => !selectedCharacteristicKeys.includes(convertFromHtmlCompatibleValue(x)));
            }
            else {
                return tempKeys;
            }
        }

        function recalculateForFiltersAfterIndex(index) {
            let selectedFilters = document.getElementsByClassName('filter');
            if (index == selectedFilters.length) {
                let selectedKey = selectedFilters[index - 1].getElementsByClassName('characteristic-key')[0].children[0].value;
                let selectedValue = selectedFilters[index - 1].getElementsByClassName('characteristic-value')[0].children[0].value;
                //Remove the last storedPriors so it can be re-calculated and displayed in the table
                storedPriors.splice(storedPriors.length - 1);
                getSpidersForSelection(selectedKey, selectedValue);
            }
            else {
                getSpidersForMultipleSelection(selectedFilters, index, getLatestPrior());                
            }
        }

        function createFilterInnerHtml() {
            return `<div class="characteristic-key dropdown-wrapper">
                        ${generateDropDownOptionsHtml(getCharacteristicKeysForOptions(), selectCharacteristicsText, "onCharacteristicKeySelected")}
                    </div>
                    <div class="px-2"> = </div>
                    <div class="characteristic-value dropdown-wrapper">
                        <select class="form-select"></select>
                    </div>
                    <div class="add-delete-filter-wrapper">
                        <button class="btn btn-add" onclick="validateAndAddFilter(event)">
                            <i class="bi bi-plus-circle" title="Add Filter"></i>
                        </button>
                        <button class="btn text-danger btn-delete" onclick="showDeleteConfirmation(event)">
                            <i class="bi bi-trash3-fill" onclick="showDeleteConfirmationByIcon(event)" title="Remove Filter"></i>
                        </button>
                    </div>
                    <div class="delete-confirmation-wrapper">
                        <button class="btn btn-confirm-yes" onclick="removeFilter(event)">
                            <i class="bi bi-check-square" onclick="removeFilterByIcon(event)" title="Confirm Delete"></i>
                        </button>
                        <button class="btn btn-confirm-no" onclick="cancelDeleteFilterOperation(event)">
                            <i class="bi bi-x-square" onclick="cancelDeleteFilterOperationByIcon(event)" title="Reject Delete"></i>
                        </button>
                    </div>
                    <div class="remove-all-button">
                        <button class="remove-all" onclick="removeAll(event)" title="Remove All Filters">Remove All
                        </button>
                    </div>`;
        }

        function selectCharacteristicValue(event) {
            let characteristicKey = event.srcElement.parentElement.parentElement.getElementsByClassName('characteristic-key')[0].children[0].value;
            let characteristicValue = event.target.value;
            getSpidersForSelection(characteristicKey, characteristicValue, event)
        }

        function disableCharacteristicKeyAndValue(event) {
            if (event != undefined) {
                event.srcElement.parentElement.parentElement.getElementsByClassName('characteristic-key')[0].children[0].disabled = true;
                event.target.disabled = true;
            }
        }

        function getSpidersForMultipleSelection(selectedFilters, index, prior){            
            let selectedKey = selectedFilters[index].getElementsByClassName('characteristic-key')[0].children[0].value;
            let selectedValue = selectedFilters[index].getElementsByClassName('characteristic-value')[0].children[0].value;                   

            $.ajax({
                url: `http://127.0.0.1:5000/api/v1/calculate_posterior?key=${selectedKey}&value=${selectedValue}`,
                dataType: 'json',
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify(prior),
                success: function (data) {                    
                    if (selectedKey != selectCharacteristicsText) {
                        storePriors(selectedKey, data);
                        addSelectedCharacteristicKey(selectedKey);
                    }

                    if(index != selectedFilters.length - 1){
                        getSpidersForMultipleSelection(selectedFilters, index + 1, getLatestPrior());
                    }
                    else{
                        populateSpiders(data);
                        document.getElementsByClassName('result-wrapper')[0].style.display = 'flex';
                        generateBubbleChartAndDisplaySummary(data);
                        toastr.success('Data Refreshed.');                        
                    }                    
                },
                error: function (error, data) {
                    toastr.error('Some error occured. Please try again.');
                    console.dir(error);
                    console.dir(data);
                }
            });
        }

        function getLatestPrior(){
            let prior = {};
            if (storedPriors.length > 0) {
                prior = storedPriors[storedPriors.length - 1].prior;
            }
            return prior;
        }

        function getSpidersForSelection(selectedKey, selectedValue, event) {
            let prior = getLatestPrior();
            $.ajax({
                url: `http://127.0.0.1:5000/api/v1/calculate_posterior?key=${selectedKey}&value=${selectedValue}`,
                dataType: 'json',
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify(prior),
                success: function (data) {
                    if (selectedKey != selectCharacteristicsText) {
                        storePriors(selectedKey, data);
                        addSelectedCharacteristicKey(selectedKey);
                        disableCharacteristicKeyAndValue(event);
                    }
                    populateSpiders(data);
                    document.getElementsByClassName('result-wrapper')[0].style.display = 'flex';
                    generateBubbleChartAndDisplaySummary(data);
                    toastr.success('Data Refreshed.');
                },
                error: function (error, data) {
                    toastr.error('Some error occured. Please try again.');
                    console.dir(error);
                    console.dir(data);
                }
            });
        }

        function addSelectedCharacteristicKey(characteristicKey) {
            if (characteristicKey != undefined && characteristicKey != '' && !selectedCharacteristicKeys.includes(characteristicKey)) {
                selectedCharacteristicKeys.push(characteristicKey);
            }
        }

        function showDeleteConfirmation(event) {
            showDeleteConfirmationByElement(event.srcElement.parentElement.parentElement);
        }

        function showDeleteConfirmationByIcon(event) {
            showDeleteConfirmationByElement(event.srcElement.parentElement.parentElement.parentElement);
            event.stopPropagation();
        }

        function cancelDeleteFilterOperation(event) {
            hideDeleteConfirmationByElement(event.srcElement.parentElement.parentElement);
        }

        function cancelDeleteFilterOperationByIcon(event) {
            hideDeleteConfirmationByElement(event.srcElement.parentElement.parentElement.parentElement);
            event.stopPropagation();
        }

        function showDeleteConfirmationByElement(element) {
            element.getElementsByClassName('add-delete-filter-wrapper')[0].style.display = 'none'
            element.getElementsByClassName('delete-confirmation-wrapper')[0].style.display = 'block';
        }

        function hideDeleteConfirmationByElement(element) {
            element.getElementsByClassName('add-delete-filter-wrapper')[0].style.display = 'block'
            element.getElementsByClassName('delete-confirmation-wrapper')[0].style.display = 'none';
        }

        function removeFilter(event) {
            removeFilterByElement(event.srcElement.parentElement.parentElement);
        }

        function removeFilterByIcon(event) {
            removeFilterByElement(event.srcElement.parentElement.parentElement.parentElement);
            event.stopPropagation();
        }

        function removeFilterByElement(element) {
            let deletingIndex = selectedCharacteristicKeys.findIndex((key) => key == element.getElementsByClassName('characteristic-key')[0].children[0].value);
            if (deletingIndex != -1) {                
                selectedCharacteristicKeys.splice(deletingIndex, 1);                
            }
            let deletingStoredPriorsIndex = storedPriors.findIndex((prior) => prior.characteristicKey == element.getElementsByClassName('characteristic-key')[0].children[0].value);
            if (deletingStoredPriorsIndex != -1) {
                removeStoredPriorsFromIndex(deletingStoredPriorsIndex);
            }
            element.remove();
            if (document.getElementsByClassName('filter').length == 0) {
                addFilter();
            }
            recalculateForFiltersAfterIndex(deletingStoredPriorsIndex - 1);
        }

        function removeStoredPriorsFromIndex(index) {
            storedPriors = storedPriors.splice(0, index);
        }

        function removeAll(event) {
            location.reload();
        }

        function storePriors(characteristicKey, rows) {
            let prior = {};
            $.each(rows, function (index, value) {
                prior[value['Species Name']] = value['Posterior']
            });
            storedPriors.push(new Prior(characteristicKey, prior));
        }

        function populateSpiderDetailsModal(speciesName, spiderDetails){
            $('#spiderDetailsModalTitle').text(speciesName);

            let spiderDetailsModalBody = []
            
            $.each(Object.keys(spiderDetails), function(index, key){
                let htmlCompatibleKey = convertToHtmlCompatibleValue(key);
                let htmlCompatibleValue = convertToHtmlCompatibleValue(spiderDetails[key]);
                spiderDetailsModalBody.push(`<div><b>${htmlCompatibleKey}</b>: ${htmlCompatibleValue}</div>`);
            });

            $('#spiderDetailsModalBody').html(spiderDetailsModalBody.join('\n'));
            $('#launchModal').click()
        }

        function fetchSpiderDetails(speciesName){
            $.ajax({
                url: `http://127.0.0.1:5000/api/v1/get_spider_details?speciesName=${speciesName}`,
                dataType: 'json',
                type: 'GET',
                contentType: "application/json",
                success: function (data) {
                    populateSpiderDetailsModal(speciesName, data);
                    toastr.success(`Species Details Loaded.`);
                },
                error: function (error, data) {
                    toastr.error('Some error occured. Please try again later.');
                    console.dir(error);
                    console.dir(data);
                }
            });
        }

        function populateSpiders(rows) {
            let html = '';
            let temp = '';
            let rowCount = 1;
            $.each(rows, function (index, value) {
                html += `<tr onclick="fetchSpiderDetails('${value['Species Name']}')" title='Click to view details'>
                                <td>${rowCount}</td>
                                <td>${value['Species Name']}</td>
                                <td>${value['Posterior']}</td>
                         </tr>`;
                rowCount += 1;
            });

            if ($.fn.dataTable.isDataTable('#spiderTable')) {
                try {
                    spidersTable.destroy();
                } catch (e) {
                }
            }
            else {
                //$('#spiderTable').show();
                //$('#spiderTable thead tr').clone(true).appendTo('#spiderTable thead');
                //$('#spiderTable').hide();
            }
            $('#spiderTableBody').html(html);
            spidersTable = $('#spiderTable').DataTable({
                orderCellsTop: true,
                pageLength: 10,
                fixedColumns: {
                    leftColumns: 3
                },
                language: {
                    "emptyTable": "<p id='emptyDataTable'>No Characteristics Selected / Error Occured.</p>"
                }
            });
        }
    </script>
</head>

<body>
    <div class="header">
        <h2 class="ps-3">Linyphiid Identification Key</h2>
    </div>
    <section class="px-3 pt-3">
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active" id="nav-search-spider-tab" data-bs-toggle="tab"
                    data-bs-target="#nav-search-spider" type="button" role="tab" aria-controls="nav-search-spider"
                    aria-selected="true"><i class="bi bi-search"></i> Spiders</button>
                <button class="nav-link" id="nav-info-tab" data-bs-toggle="tab" data-bs-target="#nav-info" type="button"
                    role="tab" aria-controls="nav-info" aria-selected="false">Info</button>
            </div>
        </nav>
        <div class="pt-3 tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-search-spider" role="tabpanel"
                aria-labelledby="nav-search-spider-tab">
                <div class="d-flex filters-chart-wrapper bg-light-yellow-green mb-3 p-4 rounded">
                    <div class="medium-height overflow-auto rounded bg-mint p-4" id="filters">
                    </div>
                    <div class="d-flex medium-height ps-4">
                        <div class="pe-4">
                            <svg width="600" height="600"></svg>
                        </div>
                        <div id="chart-summary" class="rounded p-3" style="text-align: -webkit-center;">
                            <h2>Summary</h2>
                            <div class="summary-table-wrapper overflow-auto" style="height:550px;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Posterior Probability</th>
                                            <th>Count</th>
                                        </tr>
                                    </thead>
                                    <tbody id="chart-summary-tbody">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-3 result-wrapper" style="display:none;">
                    <table id="spiderTable" class="display">
                        <thead>
                            <tr>
                                <th>SNo.</th>
                                <th>Species Name</th>
                                <th>Posterior Probability</th>
                            </tr>
                        </thead>
                        <tbody id="spiderTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-info" role="tabpanel" aria-labelledby="nav-info-tab">
                <h2>Help & Information:</h2>
                -----------------------------------------<b>Introduction to the
                    key</b>------------------------------------------
                <p>
                    This linyphiid multi-entry interactive key incorporates Bayes’ theorem with typical interactive
                    identification key features. Incorporation of Bayes’ theorem facilitates accuracy and efficiency in
                    the calculation of posterior probability values for each species; returning the most probable
                    species at the top of the list followed by species with decreasing probabilities.
                </p>
                ----------------------------------------------------<b>Usage</b>-----------------------------------------------------
                <p>
                    // (Help Image? With the UI and number labels such that each component can be explained with that?
                    Should we do that?)
                <ol>
                    <li>User may select desired character and character state subsequently making use of the dropdown on
                        the “Spiders” tab. </li>
                    <li>Once a Characteristic is selected, corresponding character states are loaded in the second
                        dropdown menu so the selection may be completed & locked.</li>
                    <li>The ‘+’ button allows addition of dropdown menus allowing further selection.</li>
                    <li>Based on user selection:
                        <ol type="a">
                            <li>The bubble chart represents posterior probabilities of the species indicated with the
                                size of the bubble. The summary alongside acts as a counter of the number of species
                                with a particular probability.</li>
                            <li>The list of spider species with an updated posterior probabilities in decreasing order.
                            </li>
                        </ol>
                    </li>
                    <li>The “dustbin” icon acts as a remove button in order to remove a selected character state.</li>
                    <li>The “Remove all” button acts as a reset button.</li>
                </ol>
                </p>
                ----------------<b>Brief description of linyphiid anatomy (to aid selection of
                    traits)</b>---------------
                <p>Overall Appearance: The overall visual appearance of the spider ranging from pale, contrasting,
                    bright, to unidentifiable.</p>
                <p>Prosoma: The cephalothorax region of the spider consisting of the head and thorax. This serves as a
                    point of attachment to various other characteristics like eyes, pedipalps, chelicerae, fovea, legs.
                    (Internal organs and structures are out of scope for the purpose of this key)</p>
                <p>Fovea: Depression formed at the thorax region of the spider.</p>
                <p>Eye row: The formation of the eyes may be:
                <ol type="a">
                    <li>Procurved: Eyes curving towards the thorax.</li>
                    <li>Recurved: Eyes curving away from the thorax</li>
                </ol>
                </p>
                <p>
                    Posterior Median Eye separation: Measurement of the distance between each eye w.r.t the diameter
                    of each eye
                </p>
                <p>
                    Opisthosoma: The “abdomen” of the spider.
                </p>
                <p>
                    Head region of the Male:
                <ol type="a">
                    <li>Sulci: pit like structure in the head.</li>
                    <li>Lobe: Raised lobe present near head.</li>
                    <li>Horns/tufts: A protruding tuft of hair from the head.</li>
                    <li>Complex: Might have more than 1 of the above.</li>
                </ol>
                </p>
                <p>
                    Chelicerae: Mouth Parts.
                </p>
                <p>
                    Apophyses: Outgrowth usually in male pedipalp.
                </p>
                <p>
                    Sternum appearance:
                <ol type="a">
                    <li>Pitted – having pits/indentations.</li>
                    <li>Rugose – having wrinkles.</li>
                </ol>
                </p>
                <p>
                    Coxae: First leg segment
                </p>
                <p>
                    Trichobothrium: Hair like structure on legs.
                </p>
                <p>
                    Cymbium: The last part of the last segment of the leg in a mature male
                </p>
                <p>
                    Paracymbium: Outgrowth of cymbium
                </p>
                <p>
                    Embolus: The final part of the genital bulb consisting of the sperm duct.
                </p>
                <p>
                    Epigyne: Point in the ventral female abdomen where the copulatory organs are present.
                </p>
            </div>
        </div>

        <div class="modal fade" id="spiderDetailsModal" tabindex="-1" aria-labelledby="spiderDetailsModalTitle"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="spiderDetailsModalTitle"></h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="spiderDetailsModalBody">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-primary" data-bs-toggle="modal" id="launchModal" data-bs-target="#spiderDetailsModal" hidden>
            Launch modal
        </button>
    </section>
</body>

</html>